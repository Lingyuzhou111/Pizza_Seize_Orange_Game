<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Roguelikeç”Ÿå­˜</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: #111;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: Arial, sans-serif;
            touch-action: none;
        }
        canvas {
            border: 1px solid #333;
            max-width: 100%;
            max-height: 100vh;
        }
        #stats {
            position: fixed;
            top: 10px;
            left: 10px;
            color: white;
            font-size: calc(12px + 1vw);
            z-index: 100;
        }
        #gameOver {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: 10px;
            font-size: calc(14px + 1vw);
            z-index: 100;
        }
        #joystick {
            position: fixed;
            bottom: 50px;
            left: 50px;
            width: 100px;
            height: 100px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: none;
            touch-action: none;
        }
        #stick {
            position: absolute;
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            top: 30px;
            left: 30px;
            touch-action: none;
        }
        @media (max-width: 768px) {
            #joystick {
                display: block;
            }
        }
    </style>
</head>
<body>
    <!-- åˆ é™¤åŸæ¥çš„imgæ ‡ç­¾ï¼Œä¸å†éœ€è¦åŠ è½½å¤–éƒ¨å›¾ç‰‡ -->
    <div id="stats">
        æ—¶é—´: <span id="time">0</span>ç§’<br>
        å‡»æ€: <span id="kills">0</span><br>
        å­å¼¹æ•°: <span id="bulletCount">1</span>
    </div>
    <canvas id="gameCanvas"></canvas>
    <div id="gameOver">
        æ¸¸æˆç»“æŸ<br>
        å­˜æ´»æ—¶é—´: <span id="finalTime">0</span>ç§’<br>
        å‡»æ€æ•°: <span id="finalKills">0</span><br>
        <button onclick="restartGame()" style="font-size: calc(12px + 1vw); padding: 10px 20px;">é‡æ–°å¼€å§‹</button>
    </div>
    <div id="joystick">
        <div id="stick"></div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // åœ¨ script æ ‡ç­¾å¼€å§‹å¤„æ·»åŠ è®¾å¤‡æ£€æµ‹å‡½æ•°
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        // æ·»åŠ ä¸€ä¸ªå…¨å±€çš„ç¼©æ”¾ç³»æ•°
        const scaleFactor = isMobileDevice() ? 0.6 : 1;

        // ä¿®æ”¹ resizeCanvas å‡½æ•°ï¼Œå¢åŠ ç§»åŠ¨è®¾å¤‡çš„è¾¹ç•Œæ‰©å±•
        function resizeCanvas() {
            const maxWidth = 800;
            const maxHeight = 600;
            const windowRatio = window.innerWidth / window.innerHeight;
            const gameRatio = maxWidth / maxHeight;

            if (windowRatio < gameRatio) {
                canvas.width = window.innerWidth * 0.95;
                canvas.height = (canvas.width / gameRatio);
            } else {
                canvas.height = window.innerHeight * 0.95;
                canvas.width = canvas.height * gameRatio;
            }

            // å¦‚æœæ˜¯ç§»åŠ¨è®¾å¤‡ï¼Œé‡æ–°åˆå§‹åŒ–æ¸¸æˆå¯¹è±¡
            if (isMobileDevice()) {
                game.player.size = 25 * scaleFactor;
                game.player.speed = 5 * scaleFactor;
                // é‡æ–°è®¾ç½®ç©å®¶ä½ç½®
                game.player.x = canvas.width / 2;
                game.player.y = canvas.height / 2;
            }
        }

        // åˆå§‹åŒ–æ—¶è°ƒæ•´ç”»å¸ƒå¤§å°
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        let game = {
            player: {
                x: canvas.width / 2,
                y: canvas.height / 2,
                size: 25,
                speed: 5,
                bulletCount: 1
            },
            bullets: [],
            enemies: [],
            powerups: [],
            time: 0,
            kills: 0,
            difficulty: 1,
            isGameOver: false,
            lastShot: 0,
            shotDelay: 250
        };

        // è™šæ‹Ÿæ‘‡æ†æ§åˆ¶
        const joystick = document.getElementById('joystick');
        const stick = document.getElementById('stick');
        let joystickData = {
            touching: false,
            startX: 0,
            startY: 0,
            moveX: 0,
            moveY: 0
        };

        function handleJoystickStart(e) {
            const touch = e.touches[0];
            const joystickRect = joystick.getBoundingClientRect();
            joystickData.touching = true;
            joystickData.startX = touch.clientX - joystickRect.left;
            joystickData.startY = touch.clientY - joystickRect.top;
            updateStickPosition(touch.clientX - joystickRect.left, touch.clientY - joystickRect.top);
        }

        function handleJoystickMove(e) {
            if (!joystickData.touching) return;
            e.preventDefault();
            const touch = e.touches[0];
            const joystickRect = joystick.getBoundingClientRect();
            const x = touch.clientX - joystickRect.left;
            const y = touch.clientY - joystickRect.top;
            updateStickPosition(x, y);
        }

        function handleJoystickEnd() {
            joystickData.touching = false;
            stick.style.transform = 'translate(-50%, -50%)';
            joystickData.moveX = 0;
            joystickData.moveY = 0;
        }

        function updateStickPosition(x, y) {
            const deltaX = x - 50;
            const deltaY = y - 50;
            const distance = Math.min(50, Math.sqrt(deltaX * deltaX + deltaY * deltaY));
            const angle = Math.atan2(deltaY, deltaX);
            const moveX = Math.cos(angle) * distance;
            const moveY = Math.sin(angle) * distance;
            
            stick.style.transform = `translate(${moveX}px, ${moveY}px)`;
            
            joystickData.moveX = moveX / 50;
            joystickData.moveY = moveY / 50;
        }

        joystick.addEventListener('touchstart', handleJoystickStart);
        joystick.addEventListener('touchmove', handleJoystickMove);
        joystick.addEventListener('touchend', handleJoystickEnd);
        joystick.addEventListener('touchcancel', handleJoystickEnd);

        const keys = {
            w: false,
            s: false,
            a: false,
            d: false
        };

        document.addEventListener('keydown', (e) => {
            if (keys.hasOwnProperty(e.key.toLowerCase())) {
                keys[e.key.toLowerCase()] = true;
            }
        });

        document.addEventListener('keyup', (e) => {
            if (keys.hasOwnProperty(e.key.toLowerCase())) {
                keys[e.key.toLowerCase()] = false;
            }
        });

        // æ›´æ–°ç©å®¶ä½ç½®çš„å‡½æ•°ç°åœ¨éœ€è¦åŒæ—¶å¤„ç†é”®ç›˜å’Œè§¦å±è¾“å…¥
        function updatePlayerPosition() {
            let dx = 0;
            let dy = 0;

            // é”®ç›˜è¾“å…¥
            if (keys.w) dy -= 1;
            if (keys.s) dy += 1;
            if (keys.a) dx -= 1;
            if (keys.d) dx += 1;

            // è§¦å±è¾“å…¥
            if (joystickData.touching) {
                dx += joystickData.moveX;
                dy += joystickData.moveY;
            }

            // æ ‡å‡†åŒ–å‘é‡
            if (dx !== 0 || dy !== 0) {
                const length = Math.sqrt(dx * dx + dy * dy);
                dx = dx / length;
                dy = dy / length;
            }

            game.player.x += dx * game.player.speed;
            game.player.y += dy * game.player.speed;

            // ç¡®ä¿ç©å®¶ä¸ä¼šç§»å‡ºç”»å¸ƒ
            game.player.x = Math.max(game.player.size, Math.min(canvas.width - game.player.size, game.player.x));
            game.player.y = Math.max(game.player.size, Math.min(canvas.height - game.player.size, game.player.y));
        }

        // åœ¨ update å‡½æ•°ä¸­æ›¿æ¢åŸæœ‰çš„ç©å®¶ç§»åŠ¨ä»£ç 
        function update() {
            if (game.isGameOver) return;

            shootBullet();
            updatePlayerPosition();

            // å…¶ä½™çš„æ›´æ–°é€»è¾‘ä¿æŒä¸å˜
            for (let i = game.bullets.length - 1; i >= 0; i--) {
                const bullet = game.bullets[i];
                bullet.x += Math.cos(bullet.angle) * bullet.speed;
                bullet.y += Math.sin(bullet.angle) * bullet.speed;
                
                if (bullet.x < 0 || bullet.x > canvas.width || 
                    bullet.y < 0 || bullet.y > canvas.height) {
                    game.bullets.splice(i, 1);
                }
            }

            for (let i = game.enemies.length - 1; i >= 0; i--) {
                const enemy = game.enemies[i];
                const dx = game.player.x - enemy.x;
                const dy = game.player.y - enemy.y;
                const dist = Math.sqrt(dx * dx + dy * dy);
                
                enemy.x += (dx / dist) * enemy.speed;
                enemy.y += (dy / dist) * enemy.speed;

                const playerDist = Math.sqrt(
                    Math.pow(game.player.x - enemy.x, 2) + 
                    Math.pow(game.player.y - enemy.y, 2)
                );
                
                if (playerDist < game.player.size + enemy.size) {
                    gameOver();
                    return;
                }

                for (let j = game.bullets.length - 1; j >= 0; j--) {
                    const bullet = game.bullets[j];
                    const bulletDist = Math.sqrt(
                        Math.pow(bullet.x - enemy.x, 2) + 
                        Math.pow(bullet.y - enemy.y, 2)
                    );
                    
                    if (bulletDist < enemy.size) {
                        spawnPowerup(enemy.x, enemy.y);
                        game.enemies.splice(i, 1);
                        game.bullets.splice(j, 1);
                        game.kills++;
                        break;
                    }
                }
            }

            for (let i = game.powerups.length - 1; i >= 0; i--) {
                const powerup = game.powerups[i];
                const dist = Math.sqrt(
                    Math.pow(game.player.x - powerup.x, 2) + 
                    Math.pow(game.player.y - powerup.y, 2)
                );
                
                if (dist < game.player.size + powerup.size) {
                    switch(powerup.type) {
                        case 'addBullet':
                            game.player.bulletCount++;
                            break;
                        case 'clearAll':
                            game.enemies = [];
                            break;
                        case 'slowEnemies':
                            game.enemies.forEach(enemy => {
                                enemy.speed = enemy.baseSpeed * 0.5;
                            });
                            break;
                    }
                    game.powerups.splice(i, 1);
                }
            }

            game.time += 1/60;
            game.difficulty = 1 + Math.floor(game.time / 30) * 0.5;

            if (Math.random() < 0.02 + (game.difficulty * 0.01)) {
                spawnEnemy();
            }

            updateUI();
        }

        // å…¶ä½™å‡½æ•°ä¿æŒä¸å˜
        function findNearestEnemy() {
            if (game.enemies.length === 0) return null;
            
            let nearestEnemy = game.enemies[0];
            let minDistance = Number.MAX_VALUE;
            
            game.enemies.forEach(enemy => {
                const dist = Math.sqrt(
                    Math.pow(game.player.x - enemy.x, 2) + 
                    Math.pow(game.player.y - enemy.y, 2)
                );
                if (dist < minDistance) {
                    minDistance = dist;
                    nearestEnemy = enemy;
                }
            });
            
            return nearestEnemy;
        }

        // ä¿®æ”¹ spawnEnemy å‡½æ•°ï¼Œè°ƒæ•´æ•Œäººå¤§å°å’Œå‡ºç”Ÿä½ç½®
        function spawnEnemy() {
            const side = Math.floor(Math.random() * 4);
            let x, y;
            const extraSpace = isMobileDevice() ? canvas.height * 0.2 : 0; // é¢å¤–çš„ç§»åŠ¨ç©ºé—´
            
            switch(side) {
                case 0: // top
                    x = Math.random() * canvas.width;
                    y = -20 - extraSpace;
                    break;
                case 1: // right
                    x = canvas.width + 20;
                    y = Math.random() * (canvas.height + extraSpace * 2) - extraSpace;
                    break;
                case 2: // bottom
                    x = Math.random() * canvas.width;
                    y = canvas.height + 20 + extraSpace;
                    break;
                case 3: // left
                    x = -20;
                    y = Math.random() * (canvas.height + extraSpace * 2) - extraSpace;
                    break;
            }

            game.enemies.push({
                x: x,
                y: y,
                size: 20 * scaleFactor,
                speed: (1 + Math.random() * game.difficulty * 0.5) * scaleFactor,
                baseSpeed: (1 + Math.random() * game.difficulty * 0.5) * scaleFactor
            });
        }

        // ä¿®æ”¹ spawnPowerup å‡½æ•°ï¼Œè°ƒæ•´é“å…·å¤§å°
        function spawnPowerup(x, y) {
            const rand = Math.random() * 100;
            let type = null;
            
            if (rand < 1) {
                type = 'clearAll';
            } else if (rand < 3) {
                type = 'addBullet';
            } else if (rand < 8) {
                type = 'slowEnemies';
            }

            if (type) {
                game.powerups.push({
                    x: x,
                    y: y,
                    type: type,
                    size: 15 * scaleFactor
                });
            }
        }

        function shootBullet() {
            const now = Date.now();
            if (now - game.lastShot < game.shotDelay) return;
            
            const nearestEnemy = findNearestEnemy();
            if (!nearestEnemy) return;
            
            const dx = nearestEnemy.x - game.player.x;
            const dy = nearestEnemy.y - game.player.y;
            const angle = Math.atan2(dy, dx);

            for (let i = 0; i < game.player.bulletCount; i++) {
                const spread = (i - (game.player.bulletCount - 1) / 2) * 0.1;
                game.bullets.push({
                    x: game.player.x,
                    y: game.player.y,
                    speed: 10,
                    angle: angle + spread
                });
            }
            
            game.lastShot = now;
        }

        // ä¿®æ”¹ draw å‡½æ•°ä¸­çš„ç›¸å…³æ¸²æŸ“å¤§å°
        function draw() {
            ctx.fillStyle = '#111';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // ç”»ç©å®¶ - è°ƒæ•´å¤§å°
            const playerImg = new Image();
            playerImg.src = './imgs/juzi.png';
            const playerDisplaySize = game.player.size * 1.5 * scaleFactor; // è°ƒæ•´æ˜¾ç¤ºå¤§å°ï¼Œå¯ä»¥æ ¹æ®éœ€è¦ä¿®æ”¹å€æ•°
            ctx.drawImage(playerImg, 
                game.player.x - playerDisplaySize, 
                game.player.y - playerDisplaySize, 
                playerDisplaySize * 2, 
                playerDisplaySize * 2
            );

            // ç”»å­å¼¹
            ctx.fillStyle = '#ff0';
            game.bullets.forEach(bullet => {
                ctx.beginPath();
                ctx.arc(bullet.x, bullet.y, 3 * scaleFactor, 0, Math.PI * 2);
                ctx.fill();
            });

            // ç”»æ•Œäºº - ä½¿ç”¨emoji
            ctx.font = `${game.player.size * 2 * scaleFactor}px Arial`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            game.enemies.forEach(enemy => {
                ctx.fillText('ğŸ•', enemy.x, enemy.y);
            });

            // ç”»é“å…· - ä½¿ç”¨emoji
            ctx.font = `${game.player.size * scaleFactor}px Arial`;  // è®¾ç½®emojiå¤§å°
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            game.powerups.forEach(powerup => {
                switch(powerup.type) {
                    case 'addBullet':
                        ctx.fillText('ğŸ', powerup.x, powerup.y);  // å­å¼¹+1é“å…·
                        break;
                    case 'clearAll':
                        ctx.fillText('ğŸ’£', powerup.x, powerup.y);  // æ¸…å±é“å…·
                        break;
                    case 'slowEnemies':
                        ctx.fillText('ğŸ±', powerup.x, powerup.y);  // å‡é€Ÿé“å…·
                        break;
                }
            });
        }

        function updateUI() {
            document.getElementById('time').textContent = Math.floor(game.time);
            document.getElementById('kills').textContent = game.kills;
            document.getElementById('bulletCount').textContent = game.player.bulletCount;
        }

        function gameOver() {
            game.isGameOver = true;
            document.getElementById('gameOver').style.display = 'block';
            document.getElementById('finalTime').textContent = Math.floor(game.time);
            document.getElementById('finalKills').textContent = game.kills;
        }

        // ä¿®æ”¹ restartGame å‡½æ•°ä¸­çš„åˆå§‹åŒ–å¤§å°
        function restartGame() {
            game = {
                player: {
                    x: canvas.width / 2,
                    y: canvas.height / 2,
                    size: 25 * scaleFactor,
                    speed: 5 * scaleFactor,
                    bulletCount: 1
                },
                bullets: [],
                enemies: [],
                powerups: [],
                time: 0,
                kills: 0,
                difficulty: 1,
                isGameOver: false,
                lastShot: 0,
                shotDelay: 250
            };
            document.getElementById('gameOver').style.display = 'none';
        }

        function gameLoop() {
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }

        gameLoop();
    </script>
</body>
</html>
